---
title: "" 
output: 
  html_document:
    theme: paper
    highlight: tango
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#library(shiny)
#runGitHub("PhaseII", "Liuqij05")

#Install the latest version of "PhIIdesign" package by entering the following in R:
#install.packages("remotes")
#remotes::install_github("IDDI-BE/PhIIdesign")

pacman::p_load(
  clinfun,      
  PhIIdesign)
```

## Single-arm Phase II Clinical Trial

##### Qijia Liu

#### Introduction

The purpose of a Phase II clinical trial is to evaluate the efficacy of potential new treatments and to determine which ones warrant further research. Due to budget constraints, the sample size is small. Hence, formal hypothesis testing is not the goal. Typically, the study design is only one arm and no comparison group. This project introduces Fleming's Single-stage Design and Simon's Two-stage Design, then compares the R output of these two designs with PASS to see if these two programs employ the same sample size calculation method.
 

#### Statistical setup for both design

**Endpoint:** Binary endpoints, ex: Tumor response: yes/no.

**Hypothesis:**

H0: $p \le p_0$ vs. Ha: $p = p_1$

* $p_0$ is a predetermined undesirable level. 
* $p_1$ is some desirable level that worth developing further.
      
**Type I and type II errors:** $\alpha$ and $\beta$.


#### Fleming’s Single-stage Design

**Single stage design:**  

Assuming that Y is the number of responses observed in n patients. A cut-point r is found such that Pr(Y ≤ r ) ≥ 1 - $\alpha$ and Pr(Y < r ) < 1 - $\alpha$. $\alpha$ is the type I error rate.

A typical decision is “Go” to a phase III trial if y > r, concluding Ha. However, “Not Go” to a phase III trial if y ≤ r, concluding H0.

* n: the total sample size.    
* r: bound for concluding H0.

```{r}
#eps: tolerance default value = 0.005

#P0 = 0.1, P1 = 0.25 Targets: Alpha = 0.05, Power = 0.8
fleming1stage(0.1, 0.25, 0.05, 0.2)
#Example 2 in Pass: P0 = 0.05, P1 = 0.25 Targets: Alpha = 0.1, Power = 0.9
fleming1stage(0.05, 0.25, 0.1, 0.1)
#Example 3a in Pass: P0 = 0.7, P1 = 0.9 Targets: Alpha = 0.05, Power = 0.8
fleming1stage(0.7, 0.9, 0.05, 0.2)
fleming1stage(0.7, 0.9, 0.05, 0.2, eps =0.001)

```


#### Simon’s Two-stage Design

**Two stages design:**  

Stage 1: Enroll and observe n1 patients, we will terminate the experiment early and reject drug or treatment if r1 or fewer responses are observed at stage 1. Otherwise, proceed to stage 2.

Stage 2: Enroll and observe n2 patients. Conclude H0 if r or fewer responses are observed among n patients(r > r1). otherwise, conclude Ha.

* n1: sample size for the first stage of accrual.      
* n2: sample size for the second stage of accrual.        
* n = n1 + n2, is the total sample size after the completion of second stage.        
* r1: bound for stopping at stage 1 (concluding H0).    
* r: bound for concluding H0 at stage 2.     

**Probability of early termination(PET):**

PET = B($r_1; p, n_1$)

where B denotes the cumulative binomial distribution. PET is the probability of an early trial termination at stage I given $p = p_1.$

**Expected samples size:**

EN = n1 + (1-PET)$n_2$ 

**Probability of not recommending:**

PNC = B($r_1; p, n_1$) + $\sum_{x = r_1 + 1}^{min[n_1, r]} b(x; p, n_1) B(r-x; p, n_2)$

**Two types of errors:**

Type I errors: $\alpha = 1 - PNC(p_0)$

Type II errors: $\beta = 1 - PNC(p_1)$


**Comparing two criteria:**

* Optimal Design

For each value of total sample size n and each value of n1 in the interval (1, n - 1), we found the integer values of r1 and r that met the two constraints and minimized the expected sample size EN when p = p0. This was obtained by a search across the range r1 in (0, n1). We computed the maximum value of r that satisfies the type II error rate for each value of r1. Then, we evaluate if these parameters (n, n1, r1, and r) meet the type I error rate. If it did, we compared the expected sample size EN to the minimum sample size obtained by previous feasible designs and continued the search over r1. Keeping n fixed, we searched the range of n1 between (1, n-1) for the optimal two-stage design for this maximum sample size n.

* Minimax Design

Only check against the constraints imposed by the two types of errors and find smallest total maximum sample size n first but skip checking for EN. 

```{r}
#P0 = 0.1, P1 = 0.25 Targets: Alpha = 0.05, Power = 0.8
ph2simon(0.1, 0.25, 0.05, 0.2)
#Example 2 in Pass: P0 = 0.05, P1 = 0.25 Targets: Alpha = 0.1, Power = 0.9
ph2simon(0.05, 0.25, 0.1, 0.1)
#Example 3a in Pass: P0 = 0.7, P1 = 0.9 Targets: Alpha = 0.05, Power = 0.8
ph2simon(0.7, 0.9, 0.05, 0.2)

```

**Interpretation:**

Using Simon's optimal/Minimax two-stage design, we test the null hypothesis that the true response rate is p0 against the alternative hypothesis that the true response rate is p1. In the first stage, n1 participants will be accrued. If there are r1 or fewer responses from these n1 participants, the trail will end. If not, go to the second stage, where n - n1 additional participants will be accrued for a total sample size of n. We will reject the null hypothesis if we observe r2 + 1 or more responses from n participants. This design yields a type I error rate at Alpha and power of Beta.
     
     
#### Comparing the output with PASS

Comparing the R output of both designs to Examples 1 and 2 in the PASS documentation yielded identical results. However, we must adjust the eps value (default is 0.05) to 0.001 in the R function of Fleming's Single-stage Design in order to obtain the same results as PASS; for Example 3b, we cannot set the "total sample size n Search Range" due to the limitation of the R function of Simon's two-stage design, so the results differ from those of PASS.
    
    
**Reference:** 

PASS documentation: [Two-Stage Designs for Tests of One
Proportion (Simon)](https://ncss-wpengine.netdna-ssl.com/wp-content/themes/ncss/pdf/Procedures/PASS/Two-Stage_Designs_for_Tests_of_One_Proportion-Simon.pdf)

Simon R (1989). Optimal two-stage designs for phase II clinical trials, Controlled Clinical Trials 10: 1-10.        
  
Fleming TR (1982). One sample multiple testing procedure for phase II clinical trials, Biometrics 38: 143-151.


